<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User-Service React Test</title>
    <style>
        body { font-family: sans-serif; margin: 2rem; }
        h1 { margin-bottom: 1rem; }
        section { border: 1px solid #ccc; border-radius: 8px; padding: 1rem; margin-bottom: 2rem; }
        h2 { margin-top: 0; }
        form > div { margin-bottom: 0.5rem; }
        label { display: inline-block; min-width: 140px; }
        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="password"] { width: 220px; }
        button { margin-right: 0.5rem; margin-top: 0.25rem; }
        pre { background: #f5f5f5; padding: 0.5rem; max-height: 250px; overflow: auto; font-size: 0.85rem; }
        img.preview { max-width: 200px; max-height: 200px; display: block; margin-top: 0.5rem; }
        .small { font-size: 0.85rem; color: #555; }
        .row { margin-bottom: 0.5rem; }
        .container { max-width: 1100px; margin: 0 auto; }
    </style>
</head>
<body>
<div id="root"></div>

<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
    const { useState, useEffect } = React;

    // ==================== Generic helpers ====================

    async function jsonFetch(url, options = {}) {
        const res = await fetch(url, options);
        if (!res.ok) {
            const text = await res.text();
            throw new Error(res.status + " " + res.statusText + ": " + text);
        }
        return res.json();
    }

    function getFormObj(form) {
        const data = new FormData(form);
        const obj = {};
        for (const [k, v] of data.entries()) {
            obj[k] = v;
        }
        return obj;
    }

    function parseChildIds(str) {
        if (!str) return [];
        return str.split(',').map((s) => s.trim()).filter((s) => s.length > 0).map(Number);
    }

    // ---------- base64url helpers for WebAuthn ----------

    function base64urlToUint8Array(base64url) {
        const padding = "=".repeat((4 - (base64url.length % 4)) % 4);
        const base64 = (base64url + padding).replace(/-/g, "+").replace(/_/g, "/");
        const raw = atob(base64);
        const output = new Uint8Array(raw.length);
        for (let i = 0; i < raw.length; ++i) {
            output[i] = raw.charCodeAt(i);
        }
        return output;
    }

    function uint8ArrayToBase64url(arr) {
        let binary = "";
        arr.forEach((b) => (binary += String.fromCharCode(b)));
        let base64 = btoa(binary);
        return base64.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
    }

    // ==================== Sections ====================

    function InfoSection() {
        return (
            <section>
                <h2>Info</h2>
                <p className="small">
                    This page calls your Spring Boot user-service directly (same origin).
                    <br />
                    Make sure your backend is running and security lets <code>/api/**</code> and the WebAuthn
                    endpoints be called.
                </p>
                <ul className="small">
                    <li>Children: <code>/api/users</code></li>
                    <li>Parents: <code>/api/parents</code></li>
                    <li>Employees: <code>/api/employees</code></li>
                    <li>Employees (admin, with password hash): <code>/api/admin/employees</code></li>
                    <li>Passkeys register: <code>/webauthn/register/options</code> ‚Üí <code>/webauthn/register</code></li>
                    <li>Passkeys login: <code>/webauthn/authenticate/options</code> ‚Üí <code>/login/webauthn</code></li>
                </ul>
            </section>
        );
    }

    // ---------- Passkeys (WebAuthn) Section ----------

    function PasskeySection() {
        const [credLabel, setCredLabel] = useState("my-device");
        const [registerStatus, setRegisterStatus] = useState("");
        const [loginStatus, setLoginStatus] = useState("");

        const [authStatus, setAuthStatus] = useState({
            checked: false,
            loggedIn: false,
            username: null,
            message: "Checking..."
        });

        const [loginUsername, setLoginUsername] = useState("");
        const [loginPassword, setLoginPassword] = useState("");
        const [loginError, setLoginError] = useState("");

        // Check if user is authenticated (using the register/options endpoint)
        const checkAuthStatus = async () => {
            try {
                const res = await fetch("/webauthn/register/options", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include"
                });

                if (res.status === 401 || res.status === 403 || res.redirected) {
                    setAuthStatus({
                        checked: true,
                        loggedIn: false,
                        username: null,
                        message: "Not logged in. Please login first at /login"
                    });
                } else if (res.ok) {
                    setAuthStatus({
                        checked: true,
                        loggedIn: true,
                        username: null,
                        message: "Logged in ‚úì ‚Äì you can register a passkey"
                    });
                } else {
                    const txt = await res.text().catch(() => "");
                    setAuthStatus({
                        checked: true,
                        loggedIn: false,
                        username: null,
                        message: "Unknown status " + res.status + (txt ? (": " + txt.slice(0, 120)) : "")
                    });
                }
            } catch (err) {
                setAuthStatus({
                    checked: true,
                    loggedIn: false,
                    username: null,
                    message: "Error checking auth: " + err.message
                });
            }
        };

        useEffect(() => {
            checkAuthStatus();
        }, []);

        const handleInlineLogin = async (e) => {
            e.preventDefault();
            setLoginError("");
            try {
                const formData = new URLSearchParams();
                formData.append("username", loginUsername);
                formData.append("password", loginPassword);

                await fetch("/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: formData.toString(),
                    credentials: "include",
                    redirect: "manual"
                });

                // Give the backend a tiny moment to set the session cookie
                setTimeout(() => {
                    checkAuthStatus();
                }, 200);
            } catch (err) {
                setLoginError("Login error: " + err.message);
            }
        };

        const handleLogout = async () => {
            try {
                await fetch("/logout", {
                    method: "POST",
                    credentials: "include",
                    redirect: "manual"
                });
                setAuthStatus({
                    checked: true,
                    loggedIn: false,
                    username: null,
                    message: "Logged out."
                });
                setRegisterStatus("");
                setLoginStatus("Logged out.");
            } catch (err) {
                setLoginStatus("Logout error: " + err.message);
            }
        };

        const registerPasskey = async () => {
            setRegisterStatus("Working...");
            try {
                if (!window.PublicKeyCredential) {
                    throw new Error("WebAuthn is not supported in this browser.");
                }

                const optionsRes = await fetch("/webauthn/register/options", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include"
                });

                const optionsContentType = optionsRes.headers.get("content-type") || "";
                const optionsText = await optionsRes.text();

                if (!optionsRes.ok) {
                    setRegisterStatus("‚ùå Server error (" + optionsRes.status + "): " + optionsText.slice(0, 300));
                    if (optionsRes.status === 401 || optionsRes.status === 403) {
                        setAuthStatus({
                            checked: true,
                            loggedIn: false,
                            username: null,
                            message: "Not logged in. Please login first."
                        });
                    }
                    return;
                }

                if (!optionsContentType.includes("application/json")) {
                    setRegisterStatus("‚ùå Not authenticated. Please login first.");
                    setAuthStatus({
                        checked: true,
                        loggedIn: false,
                        username: null,
                        message: "Not logged in. Please login first."
                    });
                    return;
                }

                const options = JSON.parse(optionsText);
                console.log("Registration options from server:", options);
                setRegisterStatus("Got options, prompting for passkey...");

                const publicKeyOptions = {
                    challenge: base64urlToUint8Array(options.challenge),
                    rp: options.rp,
                    user: {
                        ...options.user,
                        id: base64urlToUint8Array(options.user.id)
                    },
                    pubKeyCredParams: options.pubKeyCredParams,
                    timeout: options.timeout,
                    excludeCredentials: (options.excludeCredentials || []).map((cred) => ({
                        ...cred,
                        id: base64urlToUint8Array(cred.id)
                    })),
                    authenticatorSelection: options.authenticatorSelection,
                    attestation: options.attestation || "none"
                };

                const credential = await navigator.credentials.create({ publicKey: publicKeyOptions });

                if (!credential) {
                    setRegisterStatus("‚ùå Credential creation was cancelled.");
                    return;
                }

                console.log("Credential created:", credential);
                setRegisterStatus("Passkey created, sending to server...");

                const response = credential.response;
                const requestBody = {
                    publicKey: {
                        credential: {
                            id: credential.id,
                            rawId: uint8ArrayToBase64url(new Uint8Array(credential.rawId)),
                            response: {
                                attestationObject: uint8ArrayToBase64url(new Uint8Array(response.attestationObject)),
                                clientDataJSON: uint8ArrayToBase64url(new Uint8Array(response.clientDataJSON)),
                                transports: response.getTransports ? response.getTransports() : []
                            },
                            type: credential.type,
                            clientExtensionResults: credential.getClientExtensionResults(),
                            authenticatorAttachment: credential.authenticatorAttachment || "platform"
                        },
                        label: credLabel || "my-passkey"
                    }
                };

                console.log("Sending registration request:", JSON.stringify(requestBody, null, 2));

                const regRes = await fetch("/webauthn/register", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify(requestBody)
                });

                const regText = await regRes.text();
                console.log("Registration response:", regRes.status, regText);

                if (!regRes.ok) {
                    setRegisterStatus("‚ùå Registration failed (" + regRes.status + "): " + regText.slice(0, 300));
                } else {
                    setRegisterStatus("‚úÖ Passkey registered! You can now logout and login with your passkey.");
                }
            } catch (err) {
                console.error("Registration error:", err);
                if (err.name === "NotAllowedError") {
                    setRegisterStatus("‚ùå Cancelled by user.");
                } else if (err.name === "InvalidStateError") {
                    setRegisterStatus("‚ùå Passkey already exists for this authenticator.");
                } else {
                    setRegisterStatus("‚ùå Error: " + err.message);
                }
            }
        };

        const loginWithPasskey = async () => {
            setLoginStatus("Working...");
            try {
                if (!window.PublicKeyCredential) {
                    throw new Error("WebAuthn is not supported.");
                }

                const optionsRes = await fetch("/webauthn/authenticate/options", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include"
                });

                if (!optionsRes.ok) {
                    const errorText = await optionsRes.text();
                    throw new Error("Failed to get options: " + errorText.slice(0, 200));
                }

                const options = await optionsRes.json();
                console.log("Authentication options:", options);
                setLoginStatus("Got options, prompting for passkey...");

                const publicKeyOptions = {
                    challenge: base64urlToUint8Array(options.challenge),
                    timeout: options.timeout,
                    rpId: options.rpId,
                    allowCredentials: (options.allowCredentials || []).map((cred) => ({
                        type: cred.type,
                        id: base64urlToUint8Array(cred.id),
                        transports: cred.transports
                    })),
                    userVerification: options.userVerification || "preferred"
                };

                const assertion = await navigator.credentials.get({ publicKey: publicKeyOptions });

                if (!assertion) {
                    setLoginStatus("‚ùå Authentication cancelled.");
                    return;
                }

                console.log("Assertion:", assertion);
                setLoginStatus("Passkey verified, sending to server...");

                const response = assertion.response;
                const requestBody = {
                    id: assertion.id,
                    rawId: uint8ArrayToBase64url(new Uint8Array(assertion.rawId)),
                    response: {
                        authenticatorData: uint8ArrayToBase64url(new Uint8Array(response.authenticatorData)),
                        clientDataJSON: uint8ArrayToBase64url(new Uint8Array(response.clientDataJSON)),
                        signature: uint8ArrayToBase64url(new Uint8Array(response.signature)),
                        userHandle: response.userHandle
                            ? uint8ArrayToBase64url(new Uint8Array(response.userHandle))
                            : null
                    },
                    type: assertion.type,
                    clientExtensionResults: assertion.getClientExtensionResults(),
                    authenticatorAttachment: assertion.authenticatorAttachment || null
                };

                console.log("Sending login request:", JSON.stringify(requestBody, null, 2));

                const loginRes = await fetch("/login/webauthn", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify(requestBody)
                });

                const loginText = await loginRes.text();
                console.log("Login response:", loginRes.status, loginText);

                if (!loginRes.ok) {
                    setLoginStatus("‚ùå Login failed (" + loginRes.status + "): " + loginText.slice(0, 200));
                } else {
                    setLoginStatus("‚úÖ Login successful!");
                    setAuthStatus({
                        checked: true,
                        loggedIn: true,
                        username: null,
                        message: "Logged in with passkey ‚úì"
                    });
                }
            } catch (err) {
                console.error("Login error:", err);
                if (err.name === "NotAllowedError") {
                    setLoginStatus("‚ùå Cancelled by user.");
                } else {
                    setLoginStatus("‚ùå Error: " + err.message);
                }
            }
        };

        const authBadge = () => {
            if (!authStatus.checked) {
                return <span style={{ color: "#888" }}>‚è≥ {authStatus.message}</span>;
            }
            if (authStatus.loggedIn) {
                return <span style={{ color: "green" }}>‚úÖ {authStatus.message || "Logged in"}</span>;
            }
            return <span style={{ color: "red" }}>‚ùå {authStatus.message || "Not logged in"}</span>;
        };

        return (
            <section>
                <h2>Passkeys (WebAuthn)</h2>

                <div
                    style={{
                        padding: "1rem",
                        marginBottom: "1rem",
                        backgroundColor: authStatus.loggedIn ? "#e8f5e9" : "#fff3e0",
                        borderRadius: "4px",
                        border: authStatus.loggedIn ? "1px solid #a5d6a7" : "1px solid #ffcc80"
                    }}
                >
                    <strong>Status:</strong> {authBadge()}

                    {!authStatus.loggedIn && authStatus.checked && (
                        <div
                            style={{
                                marginTop: "1rem",
                                padding: "1rem",
                                backgroundColor: "#fff",
                                borderRadius: "4px"
                            }}
                        >
                            <p style={{ margin: "0 0 0.5rem 0", fontWeight: "bold" }}>
                                üîë Login first to register passkeys:
                            </p>
                            <form
                                onSubmit={handleInlineLogin}
                                style={{
                                    display: "flex",
                                    gap: "0.5rem",
                                    flexWrap: "wrap",
                                    alignItems: "center"
                                }}
                            >
                                <input
                                    type="text"
                                    value={loginUsername}
                                    onChange={(e) => setLoginUsername(e.target.value)}
                                    placeholder="Username"
                                    style={{ padding: "0.5rem", width: "120px" }}
                                />
                                <input
                                    type="password"
                                    value={loginPassword}
                                    onChange={(e) => setLoginPassword(e.target.value)}
                                    placeholder="Password"
                                    style={{ padding: "0.5rem", width: "120px" }}
                                />
                                <button
                                    type="submit"
                                    style={{
                                        padding: "0.5rem 0.75rem",
                                        border: "none",
                                        borderRadius: "4px",
                                        cursor: "pointer"
                                    }}
                                >
                                    Login
                                </button>
                                <button
                                    type="button"
                                    onClick={checkAuthStatus}
                                    style={{ padding: "0.5rem", cursor: "pointer" }}
                                >
                                    ‚Üª
                                </button>
                            </form>
                            {loginError && (
                                <p style={{ color: "red", marginTop: "0.5rem" }}>{loginError}</p>
                            )}
                            <p className="small" style={{ margin: "0.5rem 0 0 0" }}>
                                This posts to <code>/login</code> with form-encoded body.
                            </p>
                        </div>
                    )}

                    {authStatus.loggedIn && (
                        <button
                            type="button"
                            onClick={handleLogout}
                            style={{ marginTop: "0.5rem", cursor: "pointer" }}
                        >
                            Logout
                        </button>
                    )}
                </div>

                <h3>Register a new passkey</h3>
                <form
                    onSubmit={(e) => {
                        e.preventDefault();
                        registerPasskey();
                    }}
                    style={{
                        display: "flex",
                        gap: "0.5rem",
                        alignItems: "center",
                        marginBottom: "0.5rem",
                        flexWrap: "wrap"
                    }}
                >
                    <label>Passkey label:</label>
                    <input
                        type="text"
                        value={credLabel}
                        onChange={(e) => setCredLabel(e.target.value)}
                        placeholder="my-device"
                        style={{ padding: "0.5rem", minWidth: "160px" }}
                    />
                    <button
                        type="submit"
                        disabled={!authStatus.loggedIn}
                        style={{
                            padding: "0.5rem 0.75rem",
                            borderRadius: "4px",
                            cursor: authStatus.loggedIn ? "pointer" : "not-allowed"
                        }}
                    >
                        Register passkey
                    </button>
                </form>
                {registerStatus && <p className="small">{registerStatus}</p>}

                <h3>Login with passkey</h3>
                <button
                    type="button"
                    onClick={loginWithPasskey}
                    style={{
                        padding: "0.5rem 0.75rem",
                        borderRadius: "4px",
                        cursor: "pointer"
                    }}
                >
                    Login with passkey
                </button>
                {loginStatus && <p className="small">{loginStatus}</p>}
            </section>
        );
    }


    // ---------- Child User Section ----------

    function UserSection() {
        const [lastId, setLastId] = useState(null);
        const [output, setOutput] = useState("");
        const [photoUrl, setPhotoUrl] = useState("");

        const handleCreate = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const payload = {
                    name: obj.name,
                    email: obj.email,
                    password: null,
                    phoneNumber: Number(obj.phoneNumber),
                    address: obj.address,
                    departments: obj.departments,
                    profilePictureUrl: null
                };
                const user = await jsonFetch("/api/users", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                setLastId(user.id);
                setOutput(JSON.stringify(user, null, 2));
            } catch (err) {
                alert("Create user failed: " + err.message);
            }
        };

        const handleUpdate = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const id = Number(obj.id);
                const payload = {};
                if (obj.name) payload.name = obj.name;
                if (obj.email) payload.email = obj.email;
                if (obj.phoneNumber) payload.phoneNumber = Number(obj.phoneNumber);
                if (obj.address) payload.address = obj.address;
                if (obj.departments) payload.departments = obj.departments;


                const user = await jsonFetch(`/api/users/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                setOutput(JSON.stringify(user, null, 2));
            } catch (err) {
                alert("Update user failed: " + err.message);
            }
        };

        const handleUpload = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const id = Number(obj.id);
                const formData = new FormData(e.target);
                const res = await fetch(`/api/users/${id}/profile-picture`, {
                    method: "POST",
                    body: formData
                });
                if (!res.ok) throw new Error(await res.text());
                const user = await res.json();
                setOutput(JSON.stringify(user, null, 2));
                setPhotoUrl(user.profilePictureUrl);
            } catch (err) {
                alert("Upload user picture failed: " + err.message);
            }
        };

        const handleList = async () => {
            try {
                const data = await jsonFetch("/api/users");
                setOutput(JSON.stringify(data, null, 2));
            } catch (err) {
                alert("List users failed: " + err.message);
            }
        };

        const handleGet = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const id = Number(obj.id);
                const user = await jsonFetch(`/api/users/${id}`);
                setOutput(JSON.stringify(user, null, 2));
            } catch (err) {
                alert("Get user failed: " + err.message);
            }
        };

        const handleDelete = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const id = Number(obj.id);
                const res = await fetch(`/api/users/${id}`, { method: "DELETE" });
                if (!res.ok && res.status !== 204) {
                    throw new Error(res.status + " " + res.statusText + ": " + (await res.text()));
                }
                setOutput(`User ${id} deleted (and any linked parents).`);
            } catch (err) {
                alert("Delete user failed: " + err.message);
            }
        };

        return (
            <section>
                <h2>Child User</h2>

                <h3>Create User (no password)</h3>
                <form onSubmit={handleCreate}>
                    <div><label>Name:</label><input name="name" required /></div>
                    <div><label>Email:</label><input name="email" type="email" required /></div>
                    <div><label>Phone:</label><input name="phoneNumber" type="number" required /></div>
                    <div><label>Address:</label><input name="address" required /></div>
                    <div><label>Departments:</label><input name="departments" /></div> {/* üëâ NEW */}
                    <button type="submit">Create User</button>
                </form>
                <p className="small">Last created user id: <strong>{lastId ?? "-"}</strong></p>

                <h3>Update User (partial)</h3>
                <form onSubmit={handleUpdate}>
                    <div><label>User ID:</label><input name="id" type="number" required /></div>
                    <div><label>Name:</label><input name="name" /></div>
                    <div><label>Email:</label><input name="email" type="email" /></div>
                    <div><label>Phone:</label><input name="phoneNumber" type="number" /></div>
                    <div><label>Address:</label><input name="address" /></div>
                    <div><label>Departments:</label><input name="departments" /></div> {/* üëâ NEW */}
                    <button type="submit">Update User</button>
                </form>


                <h3>Upload User Profile Picture</h3>
                <form onSubmit={handleUpload} encType="multipart/form-data">
                    <div><label>User ID:</label><input name="id" type="number" required /></div>
                    <div><label>File:</label><input name="file" type="file" accept="image/*" required /></div>
                    <button type="submit">Upload User Picture</button>
                </form>
                {photoUrl && <img className="preview" src={photoUrl} alt="User" />}

                <h3>List / Get / Delete Users</h3>
                <div className="row">
                    <button onClick={handleList}>GET /api/users</button>
                </div>
                <div className="row">
                    <form onSubmit={handleGet} style={{ display: "inline-block", marginRight: "1rem" }}>
                        <label>User ID:</label><input name="id" type="number" required style={{ width: "80px" }} />
                        <button type="submit">GET /api/users/&lt;id&gt;</button>
                    </form>
                    <form onSubmit={handleDelete} style={{ display: "inline-block" }}>
                        <label>User ID:</label><input name="id" type="number" required style={{ width: "80px" }} />
                        <button type="submit">DELETE /api/users/&lt;id&gt;</button>
                    </form>
                </div>

                <pre>{output}</pre>
            </section>
        );
    }

    // ---------- Parent Section ----------

    function ParentSection() {
        const [lastId, setLastId] = useState(null);
        const [output, setOutput] = useState("");
        const [photoUrl, setPhotoUrl] = useState("");

        const handleCreate = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const payload = {
                    name: obj.name,
                    email: obj.email,
                    password: null,
                    phoneNumber: Number(obj.phoneNumber),
                    address: obj.address,
                    profilePictureUrl: null,
                    childIds: parseChildIds(obj.childIds)
                };
                const parent = await jsonFetch("/api/parents", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                setLastId(parent.id);
                setOutput(JSON.stringify(parent, null, 2));
            } catch (err) {
                alert("Create parent failed: " + err.message);
            }
        };

        const handleUpdate = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const id = Number(obj.id);
                const payload = {};
                if (obj.name) payload.name = obj.name;
                if (obj.email) payload.email = obj.email;
                if (obj.phoneNumber) payload.phoneNumber = Number(obj.phoneNumber);
                if (obj.address) payload.address = obj.address;
                if (obj.childIds) payload.childIds = parseChildIds(obj.childIds);

                const parent = await jsonFetch(`/api/parents/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                setOutput(JSON.stringify(parent, null, 2));
            } catch (err) {
                alert("Update parent failed: " + err.message);
            }
        };

        const handleUpload = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const id = Number(obj.id);
                const formData = new FormData(e.target);
                const res = await fetch(`/api/parents/${id}/profile-picture`, {
                    method: "POST",
                    body: formData
                });
                if (!res.ok) throw new Error(await res.text());
                const parent = await res.json();
                setOutput(JSON.stringify(parent, null, 2));
                setPhotoUrl(parent.profilePictureUrl);
            } catch (err) {
                alert("Upload parent picture failed: " + err.message);
            }
        };

        const handleList = async () => {
            try {
                const data = await jsonFetch("/api/parents");
                setOutput(JSON.stringify(data, null, 2));
            } catch (err) {
                alert("List parents failed: " + err.message);
            }
        };

        const handleGet = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const id = Number(obj.id);
                const parent = await jsonFetch(`/api/parents/${id}`);
                setOutput(JSON.stringify(parent, null, 2));
            } catch (err) {
                alert("Get parent failed: " + err.message);
            }
        };

        const handleDelete = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const id = Number(obj.id);
                const res = await fetch(`/api/parents/${id}`, { method: "DELETE" });
                if (!res.ok && res.status !== 204) {
                    throw new Error(res.status + " " + res.statusText + ": " + (await res.text()));
                }
                setOutput(`Parent ${id} deleted.`);
            } catch (err) {
                alert("Delete parent failed: " + err.message);
            }
        };

        return (
            <section>
                <h2>Parent</h2>

                <h3>Create Parent (no password)</h3>
                <form onSubmit={handleCreate}>
                    <div><label>Name:</label><input name="name" required /></div>
                    <div><label>Email:</label><input name="email" type="email" required /></div>
                    <div><label>Phone:</label><input name="phoneNumber" type="number" required /></div>
                    <div><label>Address:</label><input name="address" required /></div>
                    <div><label>Child IDs (comma):</label><input name="childIds" placeholder="e.g. 1,2" /></div>
                    <button type="submit">Create Parent</button>
                </form>
                <p className="small">Last created parent id: <strong>{lastId ?? "-"}</strong></p>

                <h3>Update Parent (partial)</h3>
                <form onSubmit={handleUpdate}>
                    <div><label>Parent ID:</label><input name="id" type="number" required /></div>
                    <div><label>Name:</label><input name="name" /></div>
                    <div><label>Email:</label><input name="email" type="email" /></div>
                    <div><label>Phone:</label><input name="phoneNumber" type="number" /></div>
                    <div><label>Address:</label><input name="address" /></div>
                    <div><label>Child IDs (comma):</label><input name="childIds" placeholder="e.g. 1,2" /></div>
                    <button type="submit">Update Parent</button>
                </form>

                <h3>Upload Parent Profile Picture</h3>
                <form onSubmit={handleUpload} encType="multipart/form-data">
                    <div><label>Parent ID:</label><input name="id" type="number" required /></div>
                    <div><label>File:</label><input name="file" type="file" accept="image/*" required /></div>
                    <button type="submit">Upload Parent Picture</button>
                </form>
                {photoUrl && <img className="preview" src={photoUrl} alt="Parent" />}

                <h3>List / Get / Delete Parents</h3>
                <div className="row">
                    <button onClick={handleList}>GET /api/parents</button>
                </div>
                <div className="row">
                    <form onSubmit={handleGet} style={{ display: "inline-block", marginRight: "1rem" }}>
                        <label>Parent ID:</label><input name="id" type="number" required style={{ width: "80px" }} />
                        <button type="submit">GET /api/parents/&lt;id&gt;</button>
                    </form>
                    <form onSubmit={handleDelete} style={{ display: "inline-block" }}>
                        <label>Parent ID:</label><input name="id" type="number" required style={{ width: "80px" }} />
                        <button type="submit">DELETE /api/parents/&lt;id&gt;</button>
                    </form>
                </div>

                <pre>{output}</pre>
            </section>
        );
    }

    // ---------- Employee (Password) Section ----------

    function EmployeeSection() {
        const [lastId, setLastId] = useState(null);
        const [output, setOutput] = useState("");
        const [photoUrl, setPhotoUrl] = useState("");

        const handleCreate = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const payload = {
                    name: obj.name,
                    email: obj.email,
                    password: obj.password,
                    phoneNumber: Number(obj.phoneNumber),
                    address: obj.address,
                    profilePictureUrl: null
                };
                const emp = await jsonFetch("/api/employees", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                setLastId(emp.id);
                setOutput(JSON.stringify(emp, null, 2));
            } catch (err) {
                alert("Create employee failed: " + err.message);
            }
        };

        const handleUpdate = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const id = Number(obj.id);
                const payload = {};
                if (obj.name) payload.name = obj.name;
                if (obj.email) payload.email = obj.email;
                if (obj.phoneNumber) payload.phoneNumber = Number(obj.phoneNumber);
                if (obj.address) payload.address = obj.address;

                const emp = await jsonFetch(`/api/employees/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                setOutput(JSON.stringify(emp, null, 2));
            } catch (err) {
                alert("Update employee failed: " + err.message);
            }
        };

        const handleUpload = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const id = Number(obj.id);
                const formData = new FormData(e.target);
                const res = await fetch(`/api/employees/${id}/profile-picture`, {
                    method: "POST",
                    body: formData
                });
                if (!res.ok) throw new Error(await res.text());
                const emp = await res.json();
                setOutput(JSON.stringify(emp, null, 2));
                setPhotoUrl(emp.profilePictureUrl);
            } catch (err) {
                alert("Upload employee picture failed: " + err.message);
            }
        };

        const handleLogin = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const payload = { name: obj.name, password: obj.password };
                const emp = await jsonFetch("/api/employees/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                setOutput(JSON.stringify(emp, null, 2));
            } catch (err) {
                alert("Employee login failed: " + err.message);
            }
        };

        const handleChangePassword = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const id = Number(obj.id);
                const payload = { oldPassword: obj.oldPassword, newPassword: obj.newPassword };
                const result = await jsonFetch(`/api/employees/${id}/password`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                setOutput("Password changed: " + JSON.stringify(result, null, 2));
            } catch (err) {
                alert("Change password failed: " + err.message);
            }
        };

        const handleList = async () => {
            try {
                const data = await jsonFetch("/api/employees");
                setOutput(JSON.stringify(data, null, 2));
            } catch (err) {
                alert("List employees failed: " + err.message);
            }
        };

        const handleGet = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const id = Number(obj.id);
                const emp = await jsonFetch(`/api/employees/${id}`);
                setOutput(JSON.stringify(emp, null, 2));
            } catch (err) {
                alert("Get employee failed: " + err.message);
            }
        };

        const handleDelete = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const id = Number(obj.id);
                const res = await fetch(`/api/employees/${id}`, { method: "DELETE" });
                if (!res.ok && res.status !== 204) {
                    throw new Error(res.status + " " + res.statusText + ": " + (await res.text()));
                }
                setOutput(`Employee ${id} deleted.`);
            } catch (err) {
                alert("Delete employee failed: " + err.message);
            }
        };

        return (
            <section>
                <h2>Employee (Password Auth)</h2>

                <h3>Register Employee (password REQUIRED)</h3>
                <form onSubmit={handleCreate}>
                    <div><label>Name:</label><input name="name" required /></div>
                    <div><label>Email:</label><input name="email" type="email" required /></div>
                    <div><label>Password:</label><input name="password" type="password" required /></div>
                    <div><label>Phone:</label><input name="phoneNumber" type="number" required /></div>
                    <div><label>Address:</label><input name="address" required /></div>
                    <button type="submit">Create Employee</button>
                </form>
                <p className="small">Last created employee id: <strong>{lastId ?? "-"}</strong></p>

                <h3>Update Employee (partial)</h3>
                <form onSubmit={handleUpdate}>
                    <div><label>Employee ID:</label><input name="id" type="number" required /></div>
                    <div><label>Name:</label><input name="name" /></div>
                    <div><label>Email:</label><input name="email" type="email" /></div>
                    <div><label>Phone:</label><input name="phoneNumber" type="number" /></div>
                    <div><label>Address:</label><input name="address" /></div>
                    <button type="submit">Update Employee</button>
                </form>

                <h3>Change Employee Password</h3>
                <form onSubmit={handleChangePassword}>
                    <div><label>Employee ID:</label><input name="id" type="number" required /></div>
                    <div><label>Old Password:</label><input name="oldPassword" type="password" required /></div>
                    <div><label>New Password:</label><input name="newPassword" type="password" required /></div>
                    <button type="submit">Change Password</button>
                </form>

                <h3>Upload Employee Profile Picture</h3>
                <form onSubmit={handleUpload} encType="multipart/form-data">
                    <div><label>Employee ID:</label><input name="id" type="number" required /></div>
                    <div><label>File:</label><input name="file" type="file" accept="image/*" required /></div>
                    <button type="submit">Upload Employee Picture</button>
                </form>
                {photoUrl && <img className="preview" src={photoUrl} alt="Employee" />}

                <h3>Employee Login (via /api/employees/login)</h3>
                <form onSubmit={handleLogin}>
                    <div><label>Name:</label><input name="name" required /></div>
                    <div><label>Password:</label><input name="password" type="password" required /></div>
                    <button type="submit">Login</button>
                </form>

                <h3>List / Get / Delete Employees</h3>
                <div className="row">
                    <button onClick={handleList}>GET /api/employees</button>
                </div>
                <div className="row">
                    <form onSubmit={handleGet} style={{ display: "inline-block", marginRight: "1rem" }}>
                        <label>Employee ID:</label><input name="id" type="number" required style={{ width: "80px" }} />
                        <button type="submit">GET /api/employees/&lt;id&gt;</button>
                    </form>
                    <form onSubmit={handleDelete} style={{ display: "inline-block" }}>
                        <label>Employee ID:</label><input name="id" type="number" required style={{ width: "80px" }} />
                        <button type="submit">DELETE /api/employees/&lt;id&gt;</button>
                    </form>
                </div>

                <pre>{output}</pre>
            </section>
        );
    }

    // ---------- Admin Employees (with password hash) ----------

    function AdminEmployeeSection() {
        const [output, setOutput] = useState("");

        const handleList = async () => {
            try {
                const data = await jsonFetch("/api/admin/employees");
                setOutput(JSON.stringify(data, null, 2));
            } catch (err) {
                alert("Admin list employees failed: " + err.message);
            }
        };

        const handleGet = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const id = Number(obj.id);
                const emp = await jsonFetch(`/api/admin/employees/${id}`);
                setOutput(JSON.stringify(emp, null, 2));
            } catch (err) {
                alert("Admin get employee failed: " + err.message);
            }
        };

        return (
            <section>
                <h2>Admin ‚Äì Employees With Password Hash</h2>
                <p className="small">
                    From <code>EmployeeAdminController</code> ‚Äì includes encoded <code>passwordHash</code>.
                    Dev-only; don&apos;t expose in real production.
                </p>
                <div className="row">
                    <button onClick={handleList}>GET /api/admin/employees</button>
                </div>
                <div className="row">
                    <form onSubmit={handleGet}>
                        <label>Employee ID:</label><input name="id" type="number" required style={{ width: "80px" }} />
                        <button type="submit">GET /api/admin/employees/&lt;id&gt;</button>
                    </form>
                </div>
                <pre>{output}</pre>
            </section>
        );
    }

    function App() {
        return (
            <div className="container">
                <h1>User-Service React Test</h1>
                <p className="small">
                    Dev playground for all controllers + password login + passkeys + change password + partial updates.
                </p>
                <InfoSection />
                <PasskeySection />
                <EmployeeSection />
                <AdminEmployeeSection />
                <UserSection />
                <ParentSection />
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
</script>
</body>
</html>
