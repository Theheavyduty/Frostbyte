<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User-Service React Test</title>
    <style>
        body { font-family: sans-serif; margin: 2rem; }
        h1 { margin-bottom: 1rem; }
        section { border: 1px solid #ccc; border-radius: 8px; padding: 1rem; margin-bottom: 2rem; }
        h2 { margin-top: 0; }
        form > div { margin-bottom: 0.5rem; }
        label { display: inline-block; min-width: 140px; }
        input[type="text"],
        input[type="date"],
        input[type="number"],
        input[type="email"],
        input[type="password"] { width: 220px; }
        button { margin-right: 0.5rem; margin-top: 0.25rem; }
        pre { background: #f5f5f5; padding: 0.5rem; max-height: 250px; overflow: auto; font-size: 0.85rem; }
        img.preview { max-width: 200px; max-height: 200px; display: block; margin-top: 0.5rem; }
        .small { font-size: 0.85rem; color: #555; }
        .row { margin-bottom: 0.5rem; }
        .container { max-width: 1100px; margin: 0 auto; }
    </style>
</head>
<body>
<div id="root"></div>

<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
    const { useState, useEffect } = React;

    // ==================== Generic helpers ====================

    async function jsonFetch(url, options = {}) {
        const res = await fetch(url, options);
        if (!res.ok) {
            const text = await res.text();
            throw new Error(res.status + " " + res.statusText + ": " + text);
        }
        return res.json();
    }

    function getFormObj(form) {
        const data = new FormData(form);
        const obj = {};
        for (const [k, v] of data.entries()) {
            obj[k] = v;
        }
        return obj;
    }

    function parseChildIds(str) {
        if (!str) return [];
        return str.split(',').map((s) => s.trim()).filter((s) => s.length > 0).map(Number);
    }

    // ---------- base64url helpers for WebAuthn ----------

    function base64urlToUint8Array(base64url) {
        const padding = "=".repeat((4 - (base64url.length % 4)) % 4);
        const base64 = (base64url + padding).replace(/-/g, "+").replace(/_/g, "/");
        const raw = atob(base64);
        const output = new Uint8Array(raw.length);
        for (let i = 0; i < raw.length; ++i) {
            output[i] = raw.charCodeAt(i);
        }
        return output;
    }

    function uint8ArrayToBase64url(arr) {
        let binary = "";
        arr.forEach((b) => (binary += String.fromCharCode(b)));
        let base64 = btoa(binary);
        return base64.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
    }

    // ==================== Sections ====================

    function InfoSection() {
        return (
            <section>
                <h2>Info</h2>
                <p className="small">
                    This page calls your Spring Boot user-service directly (same origin).
                    <br />
                    Make sure your backend is running and security lets <code>/api/**</code> and the WebAuthn
                    endpoints be called.
                </p>
                <ul className="small">
                    <li>Children: <code>/api/children</code></li>
                    <li>Parents: <code>/api/parents</code></li>
                    <li>Employees: <code>/api/employees</code></li>
                    <li>Employees (admin, with password hash): <code>/api/admin/employees</code></li>
                    <li>Passkeys register: <code>/webauthn/register/options</code> → <code>/webauthn/register</code></li>
                    <li>Passkeys login: <code>/webauthn/authenticate/options</code> → <code>/login/webauthn</code></li>
                </ul>
            </section>
        );
    }

    // ---------- Passkeys (WebAuthn) Section ----------

    function PasskeySection() {
        const [credLabel, setCredLabel] = useState("my-device");
        const [registerStatus, setRegisterStatus] = useState("");
        const [loginStatus, setLoginStatus] = useState("");

        const [authStatus, setAuthStatus] = useState({
            checked: false,
            loggedIn: false,
            username: null,
            message: "Checking..."
        });

        const [loginUsername, setLoginUsername] = useState("");
        const [loginPassword, setLoginPassword] = useState("");
        const [loginError, setLoginError] = useState("");

        // Check if user is authenticated (using the register/options endpoint)
        const checkAuthStatus = async () => {
            try {
                const res = await fetch("/webauthn/register/options", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include"
                });

                if (res.status === 401 || res.status === 403 || res.redirected) {
                    setAuthStatus({
                        checked: true,
                        loggedIn: false,
                        username: null,
                        message: "Not logged in. Please login first."
                    });
                } else if (res.ok) {
                    setAuthStatus({
                        checked: true,
                        loggedIn: true,
                        username: null,
                        message: "Logged in ✓ – you can register a passkey"
                    });
                } else {
                    const txt = await res.text().catch(() => "");
                    setAuthStatus({
                        checked: true,
                        loggedIn: false,
                        username: null,
                        message: "Unknown status " + res.status + (txt ? (": " + txt.slice(0, 120)) : "")
                    });
                }
            } catch (err) {
                setAuthStatus({
                    checked: true,
                    loggedIn: false,
                    username: null,
                    message: "Error checking auth: " + err.message
                });
            }
        };

        useEffect(() => {
            checkAuthStatus();
        }, []);

        const handleInlineLogin = async (e) => {
            e.preventDefault();
            setLoginError("");
            try {
                const formData = new URLSearchParams();
                formData.append("username", loginUsername);
                formData.append("password", loginPassword);

                const res = await fetch("/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: formData.toString(),
                    credentials: "include",
                    redirect: "manual"
                });

                // Give the backend a tiny moment to set the session cookie
                setTimeout(() => {
                    checkAuthStatus();
                }, 200);
            } catch (err) {
                setLoginError("Login error: " + err.message);
            }
        };

        const handleLogout = async () => {
            try {
                console.log("Attempting logout...");

                const res = await fetch("/logout", {
                    method: "POST",
                    credentials: "include",
                    redirect: "follow",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    }
                });

                console.log("Logout response status:", res.status);

                // Even if we get a 404 (from redirect to /login?logout), the session
                // has been invalidated. The logout itself succeeded.
                // Spring Security clears the session BEFORE redirecting.

                // Update UI immediately
                setAuthStatus({
                    checked: true,
                    loggedIn: false,
                    username: null,
                    message: "Not logged in. Please login first."
                });

                // Also verify with backend after a short delay
                setTimeout(() => {
                    checkAuthStatus();
                }, 300);
            } catch (err) {
                console.error("Logout error:", err);
                // Still update UI and check auth status even if there was an error
                setAuthStatus({
                    checked: true,
                    loggedIn: false,
                    username: null,
                    message: "Logged out (with error: " + err.message + ")"
                });
                setTimeout(() => {
                    checkAuthStatus();
                }, 300);
            }
        };

// Add this debug version to see what the backend is actually returning

        const handleRegisterPasskey = async (e) => {
            e.preventDefault();
            setRegisterStatus("Getting registration options...");

            try {
                // 1) Request registration options from the server
                const optionsRes = await fetch("/webauthn/register/options", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify({ label: credLabel })
                });

                console.log("Response status:", optionsRes.status);
                console.log("Response headers:", Object.fromEntries(optionsRes.headers.entries()));

                if (!optionsRes.ok) {
                    const errorText = await optionsRes.text();
                    console.error("Error response:", errorText);
                    throw new Error(`Server returned ${optionsRes.status} ${optionsRes.statusText}: ${errorText}`);
                }

                const responseText = await optionsRes.text();
                console.log("Raw response text:", responseText);

                let optionsJson;
                try {
                    optionsJson = JSON.parse(responseText);
                } catch (parseError) {
                    console.error("JSON parse error:", parseError);
                    throw new Error("Server returned invalid JSON: " + responseText.substring(0, 100));
                }

                console.log("Parsed JSON:", optionsJson);
                console.log("Has publicKey?", "publicKey" in optionsJson);
                console.log("Keys in response:", Object.keys(optionsJson));

                // Check if this is a direct publicKey object or wrapped
                let publicKeyOptions;
                if (optionsJson.publicKey) {
                    publicKeyOptions = optionsJson.publicKey;
                } else if (optionsJson.challenge) {
                    // Maybe the response IS the publicKey object
                    publicKeyOptions = optionsJson;
                } else {
                    throw new Error("Invalid response format. Response keys: " + Object.keys(optionsJson).join(", "));
                }

                console.log("Using publicKey options:", publicKeyOptions);

                if (!publicKeyOptions.challenge) {
                    throw new Error("Missing challenge in response");
                }

                // Convert base64url fields to Uint8Array
                const publicKey = {
                    ...publicKeyOptions,
                    challenge: base64urlToUint8Array(publicKeyOptions.challenge),
                    user: {
                        ...publicKeyOptions.user,
                        id: base64urlToUint8Array(publicKeyOptions.user.id)
                    }
                };

                if (publicKeyOptions.excludeCredentials) {
                    publicKey.excludeCredentials = publicKeyOptions.excludeCredentials.map((cred) => ({
                        ...cred,
                        id: base64urlToUint8Array(cred.id)
                    }));
                }

                setRegisterStatus("Waiting for authenticator...");

                // 2) Call the browser's WebAuthn create()
                const credential = await navigator.credentials.create({ publicKey });

                setRegisterStatus("Sending credential to server...");

                // 3) Convert the new credential to base64url and extract all required fields
                const credentialId = uint8ArrayToBase64url(new Uint8Array(credential.rawId));
                const clientDataJSON = uint8ArrayToBase64url(
                    new Uint8Array(credential.response.clientDataJSON)
                );
                const attestationObject = uint8ArrayToBase64url(
                    new Uint8Array(credential.response.attestationObject)
                );

                // Get the public key and authenticator data from the credential response
                const authenticatorData = credential.response.getAuthenticatorData
                    ? uint8ArrayToBase64url(new Uint8Array(credential.response.getAuthenticatorData()))
                    : null;
                const publicKeyBytes = credential.response.getPublicKey
                    ? uint8ArrayToBase64url(new Uint8Array(credential.response.getPublicKey()))
                    : null;
                const publicKeyAlgorithm = credential.response.getPublicKeyAlgorithm
                    ? credential.response.getPublicKeyAlgorithm()
                    : -7; // Default to ES256 if not available

                // Spring Security WebAuthn expects this specific format:
                // publicKey.credential (the credential data) + publicKey.label
                const registrationData = {
                    publicKey: {
                        credential: {
                            id: credential.id,
                            rawId: credentialId,
                            response: {
                                attestationObject,
                                clientDataJSON,
                                transports: credential.response.getTransports ? credential.response.getTransports() : []
                            },
                            type: credential.type,
                            clientExtensionResults: credential.getClientExtensionResults ? credential.getClientExtensionResults() : {},
                            authenticatorAttachment: credential.authenticatorAttachment || "platform"
                        },
                        label: credLabel || "my-passkey"
                    }
                };

                console.log("Sending registration data:", JSON.stringify(registrationData, null, 2));

                // 4) POST the new credential
                const registerRes = await fetch("/webauthn/register", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify(registrationData)
                });

                if (!registerRes.ok) {
                    const errorText = await registerRes.text();
                    throw new Error(`Server returned ${registerRes.status}: ${errorText}`);
                }

                setRegisterStatus("✅ Passkey registered successfully!");
            } catch (err) {
                console.error("Registration error:", err);
                setRegisterStatus("❌ Error: " + err.message);
            }
        };

        const handleLoginWithPasskey = async (e) => {
            e.preventDefault();
            setLoginStatus("Getting authentication options...");

            try {
                // 1) Request authentication options
                const optionsRes = await fetch("/webauthn/authenticate/options", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify({})
                });

                if (!optionsRes.ok) {
                    throw new Error(`Server returned ${optionsRes.status} ${optionsRes.statusText}`);
                }

                const optionsJson = await optionsRes.json();
                console.log("Authentication options:", optionsJson);

                // Handle both wrapped {publicKey: {...}} and direct {...} response formats
                let publicKeyOptions;
                if (optionsJson.publicKey) {
                    publicKeyOptions = optionsJson.publicKey;
                } else if (optionsJson.challenge) {
                    // Response IS the publicKey object directly
                    publicKeyOptions = optionsJson;
                } else {
                    throw new Error("Invalid response format: missing publicKey or challenge. Keys: " + Object.keys(optionsJson).join(", "));
                }

                if (!publicKeyOptions.challenge) {
                    throw new Error("Invalid response format: missing challenge");
                }

                // Convert base64url fields
                const publicKey = {
                    ...publicKeyOptions,
                    challenge: base64urlToUint8Array(publicKeyOptions.challenge)
                };

                if (publicKeyOptions.allowCredentials) {
                    publicKey.allowCredentials = publicKeyOptions.allowCredentials.map((cred) => ({
                        ...cred,
                        id: base64urlToUint8Array(cred.id)
                    }));
                }

                setLoginStatus("Waiting for authenticator...");

                // 2) Call the browser's WebAuthn get()
                const assertion = await navigator.credentials.get({ publicKey });

                setLoginStatus("Sending authentication to server...");

                // 3) Convert the assertion
                const credentialId = uint8ArrayToBase64url(new Uint8Array(assertion.rawId));
                const clientDataJSON = uint8ArrayToBase64url(
                    new Uint8Array(assertion.response.clientDataJSON)
                );
                const authenticatorData = uint8ArrayToBase64url(
                    new Uint8Array(assertion.response.authenticatorData)
                );
                const signature = uint8ArrayToBase64url(new Uint8Array(assertion.response.signature));

                let userHandle = "";
                if (assertion.response.userHandle) {
                    userHandle = uint8ArrayToBase64url(new Uint8Array(assertion.response.userHandle));
                }

                const authData = {
                    id: assertion.id,
                    rawId: credentialId,
                    response: {
                        clientDataJSON,
                        authenticatorData,
                        signature,
                        userHandle
                    },
                    type: assertion.type
                };

                // 4) POST to /login/webauthn
                const loginRes = await fetch("/login/webauthn", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify(authData)
                });

                if (!loginRes.ok) {
                    const errorText = await loginRes.text();
                    throw new Error(`Server returned ${loginRes.status}: ${errorText}`);
                }

                setLoginStatus("✅ Logged in successfully with passkey!");

                // Update auth status
                setTimeout(() => {
                    checkAuthStatus();
                }, 200);
            } catch (err) {
                console.error("Login error:", err);
                setLoginStatus("❌ Error: " + err.message);
            }
        };

        return (
            <section>
                <h2>Passkeys (WebAuthn)</h2>

                <p className="small">
                    <strong>Auth status:</strong> {authStatus.message}
                </p>

                {!authStatus.loggedIn && (
                    <div>
                        <h3>Login with Username/Password First</h3>
                        <form onSubmit={handleInlineLogin}>
                            <div>
                                <label>Username:</label>
                                <input
                                    type="text"
                                    value={loginUsername}
                                    onChange={(e) => setLoginUsername(e.target.value)}
                                    placeholder="user"
                                    required
                                />
                            </div>
                            <div>
                                <label>Password:</label>
                                <input
                                    type="password"
                                    value={loginPassword}
                                    onChange={(e) => setLoginPassword(e.target.value)}
                                    placeholder="password"
                                    required
                                />
                            </div>
                            <button type="submit">Login</button>
                        </form>
                        {loginError && <p style={{ color: "red" }}>{loginError}</p>}
                    </div>
                )}

                {authStatus.loggedIn && (
                    <div>
                        <h3>Register a Passkey</h3>
                        <form onSubmit={handleRegisterPasskey}>
                            <div>
                                <label>Credential Label:</label>
                                <input
                                    type="text"
                                    value={credLabel}
                                    onChange={(e) => setCredLabel(e.target.value)}
                                    required
                                />
                            </div>
                            <button type="submit">Register Passkey</button>
                        </form>
                        <p className="small">{registerStatus}</p>

                        <button onClick={handleLogout} style={{ marginTop: "1rem" }}>Logout</button>
                    </div>
                )}

                <h3>Login with Passkey (Passwordless)</h3>
                <form onSubmit={handleLoginWithPasskey}>
                    <button type="submit">Login with Passkey</button>
                </form>
                <p className="small">{loginStatus}</p>
            </section>
        );
    }

    // ---------- Children Section ----------

    function ChildrenSection() {
        const [output, setOutput] = useState("");
        const [lastId, setLastId] = useState(null);
        const [photoUrl, setPhotoUrl] = useState("");

        const handleCreate = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const payload = {
                    name: obj.name,
                    email: obj.email,
                    phoneNumber: parseInt(obj.phoneNumber, 10),
                    address: obj.address,
                    departments: obj.departments,
                    birthday: obj.birthday || null
                };
                const child = await jsonFetch("/api/children", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                setLastId(child.id);
                setOutput("Created child:\n" + JSON.stringify(child, null, 2));
            } catch (err) {
                alert("Create child failed: " + err.message);
            }
        };

        const handleUpdate = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const id = Number(obj.id);
                const payload = {};
                if (obj.name) payload.name = obj.name;
                if (obj.email) payload.email = obj.email;
                if (obj.phoneNumber) payload.phoneNumber = parseInt(obj.phoneNumber, 10);
                if (obj.address) payload.address = obj.address;
                if (obj.departments) payload.departments = obj.departments;
                if (obj.birthday) payload.birthday = obj.birthday;

                const updated = await jsonFetch(`/api/children/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                setOutput("Updated child:\n" + JSON.stringify(updated, null, 2));
            } catch (err) {
                alert("Update child failed: " + err.message);
            }
        };

        const handleUpload = async (e) => {
            e.preventDefault();
            try {
                const formData = new FormData(e.target);
                const id = formData.get("id");
                const file = formData.get("file");

                const uploadFormData = new FormData();
                uploadFormData.append("file", file);

                const res = await fetch(`/api/children/${id}/profile-picture`, {
                    method: "POST",
                    body: uploadFormData
                });

                if (!res.ok) {
                    throw new Error(`Upload failed: ${res.status} ${res.statusText}`);
                }

                const child = await res.json();
                setPhotoUrl(child.profilePictureUrl);
                setOutput("Uploaded picture for child:\n" + JSON.stringify(child, null, 2));
            } catch (err) {
                alert("Upload failed: " + err.message);
            }
        };

        const handleList = async () => {
            try {
                const data = await jsonFetch("/api/children");
                setOutput(JSON.stringify(data, null, 2));
            } catch (err) {
                alert("List children failed: " + err.message);
            }
        };

        const handleGet = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const id = Number(obj.id);
                const child = await jsonFetch(`/api/children/${id}`);
                setOutput(JSON.stringify(child, null, 2));
            } catch (err) {
                alert("Get child failed: " + err.message);
            }
        };

        const handleDelete = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const id = Number(obj.id);
                const res = await fetch(`/api/children/${id}`, { method: "DELETE" });
                if (!res.ok && res.status !== 204) {
                    throw new Error(res.status + " " + res.statusText + ": " + (await res.text()));
                }
                setOutput(`Child ${id} deleted.`);
            } catch (err) {
                alert("Delete child failed: " + err.message);
            }
        };

        return (
            <section>
                <h2>Children</h2>

                <h3>Register Child (no password)</h3>
                <form onSubmit={handleCreate}>
                    <div><label>Name:</label><input name="name" required /></div>
                    <div><label>Email:</label><input name="email" type="email" required /></div>
                    <div><label>Phone:</label><input name="phoneNumber" type="number" required /></div>
                    <div><label>Address:</label><input name="address" required /></div>
                    <div><label>Departments:</label><input name="departments" required /></div>
                    <div><label>Birthday:</label><input name="birthday" type="date" /></div>
                    <button type="submit">Create Child</button>
                </form>
                <p className="small">Last created child id: <strong>{lastId ?? "-"}</strong></p>

                <h3>Update Child (partial)</h3>
                <form onSubmit={handleUpdate}>
                    <div><label>Child ID:</label><input name="id" type="number" required /></div>
                    <div><label>Name:</label><input name="name" /></div>
                    <div><label>Email:</label><input name="email" type="email" /></div>
                    <div><label>Phone:</label><input name="phoneNumber" type="number" /></div>
                    <div><label>Address:</label><input name="address" /></div>
                    <div><label>Departments:</label><input name="departments" /></div>
                    <div><label>Birthday:</label><input name="birthday" type="date" /></div>
                    <button type="submit">Update Child</button>
                </form>

                <h3>Upload Child Profile Picture</h3>
                <form onSubmit={handleUpload} encType="multipart/form-data">
                    <div><label>Child ID:</label><input name="id" type="number" required /></div>
                    <div><label>File:</label><input name="file" type="file" accept="image/*" required /></div>
                    <button type="submit">Upload Child Picture</button>
                </form>
                {photoUrl && <img className="preview" src={photoUrl} alt="Child" />}

                <h3>List / Get / Delete Children</h3>
                <div className="row">
                    <button onClick={handleList}>GET /api/children</button>
                </div>
                <div className="row">
                    <form onSubmit={handleGet} style={{ display: "inline-block", marginRight: "1rem" }}>
                        <label>Child ID:</label><input name="id" type="number" required style={{ width: "80px" }} />
                        <button type="submit">GET /api/children/&lt;id&gt;</button>
                    </form>
                    <form onSubmit={handleDelete} style={{ display: "inline-block" }}>
                        <label>Child ID:</label><input name="id" type="number" required style={{ width: "80px" }} />
                        <button type="submit">DELETE /api/children/&lt;id&gt;</button>
                    </form>
                </div>

                <pre>{output}</pre>
            </section>
        );
    }

    // ---------- Parent Section ----------

    function ParentSection() {
        const [output, setOutput] = useState("");
        const [lastId, setLastId] = useState(null);
        const [photoUrl, setPhotoUrl] = useState("");

        const handleCreate = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const childIds = parseChildIds(obj.childIds);
                const payload = {
                    name: obj.name,
                    email: obj.email,
                    phoneNumber: parseInt(obj.phoneNumber, 10),
                    address: obj.address,
                    childIds
                };
                const parent = await jsonFetch("/api/parents", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                setLastId(parent.id);
                setOutput("Created parent:\n" + JSON.stringify(parent, null, 2));
            } catch (err) {
                alert("Create parent failed: " + err.message);
            }
        };

        const handleUpdate = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const id = Number(obj.id);
                const payload = {};
                if (obj.name) payload.name = obj.name;
                if (obj.email) payload.email = obj.email;
                if (obj.phoneNumber) payload.phoneNumber = parseInt(obj.phoneNumber, 10);
                if (obj.address) payload.address = obj.address;
                if (obj.childIds) {
                    payload.childIds = parseChildIds(obj.childIds);
                }

                const updated = await jsonFetch(`/api/parents/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                setOutput("Updated parent:\n" + JSON.stringify(updated, null, 2));
            } catch (err) {
                alert("Update parent failed: " + err.message);
            }
        };

        const handleUpload = async (e) => {
            e.preventDefault();
            try {
                const formData = new FormData(e.target);
                const id = formData.get("id");
                const file = formData.get("file");

                const uploadFormData = new FormData();
                uploadFormData.append("file", file);

                const res = await fetch(`/api/parents/${id}/profile-picture`, {
                    method: "POST",
                    body: uploadFormData
                });

                if (!res.ok) {
                    throw new Error(`Upload failed: ${res.status} ${res.statusText}`);
                }

                const parent = await res.json();
                setPhotoUrl(parent.profilePictureUrl);
                setOutput("Uploaded picture for parent:\n" + JSON.stringify(parent, null, 2));
            } catch (err) {
                alert("Upload failed: " + err.message);
            }
        };

        const handleList = async () => {
            try {
                const data = await jsonFetch("/api/parents");
                setOutput(JSON.stringify(data, null, 2));
            } catch (err) {
                alert("List parents failed: " + err.message);
            }
        };

        const handleGet = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const id = Number(obj.id);
                const parent = await jsonFetch(`/api/parents/${id}`);
                setOutput(JSON.stringify(parent, null, 2));
            } catch (err) {
                alert("Get parent failed: " + err.message);
            }
        };

        const handleDelete = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const id = Number(obj.id);
                const res = await fetch(`/api/parents/${id}`, { method: "DELETE" });
                if (!res.ok && res.status !== 204) {
                    throw new Error(res.status + " " + res.statusText + ": " + (await res.text()));
                }
                setOutput(`Parent ${id} deleted.`);
            } catch (err) {
                alert("Delete parent failed: " + err.message);
            }
        };

        return (
            <section>
                <h2>Parent</h2>

                <h3>Register Parent (no password)</h3>
                <form onSubmit={handleCreate}>
                    <div><label>Name:</label><input name="name" required /></div>
                    <div><label>Email:</label><input name="email" type="email" required /></div>
                    <div><label>Phone:</label><input name="phoneNumber" type="number" required /></div>
                    <div><label>Address:</label><input name="address" required /></div>
                    <div><label>Child IDs (comma-separated):</label><input name="childIds" /></div>
                    <button type="submit">Create Parent</button>
                </form>
                <p className="small">Last created parent id: <strong>{lastId ?? "-"}</strong></p>

                <h3>Update Parent (partial)</h3>
                <form onSubmit={handleUpdate}>
                    <div><label>Parent ID:</label><input name="id" type="number" required /></div>
                    <div><label>Name:</label><input name="name" /></div>
                    <div><label>Email:</label><input name="email" type="email" /></div>
                    <div><label>Phone:</label><input name="phoneNumber" type="number" /></div>
                    <div><label>Address:</label><input name="address" /></div>
                    <div><label>Child IDs (comma-separated):</label><input name="childIds" /></div>
                    <button type="submit">Update Parent</button>
                </form>

                <h3>Upload Parent Profile Picture</h3>
                <form onSubmit={handleUpload} encType="multipart/form-data">
                    <div><label>Parent ID:</label><input name="id" type="number" required /></div>
                    <div><label>File:</label><input name="file" type="file" accept="image/*" required /></div>
                    <button type="submit">Upload Parent Picture</button>
                </form>
                {photoUrl && <img className="preview" src={photoUrl} alt="Parent" />}

                <h3>List / Get / Delete Parents</h3>
                <div className="row">
                    <button onClick={handleList}>GET /api/parents</button>
                </div>
                <div className="row">
                    <form onSubmit={handleGet} style={{ display: "inline-block", marginRight: "1rem" }}>
                        <label>Parent ID:</label><input name="id" type="number" required style={{ width: "80px" }} />
                        <button type="submit">GET /api/parents/&lt;id&gt;</button>
                    </form>
                    <form onSubmit={handleDelete} style={{ display: "inline-block" }}>
                        <label>Parent ID:</label><input name="id" type="number" required style={{ width: "80px" }} />
                        <button type="submit">DELETE /api/parents/&lt;id&gt;</button>
                    </form>
                </div>

                <pre>{output}</pre>
            </section>
        );
    }

    // ---------- Employee Section ----------

    function EmployeeSection() {
        const [output, setOutput] = useState("");
        const [lastId, setLastId] = useState(null);
        const [photoUrl, setPhotoUrl] = useState("");

        const handleCreate = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const payload = {
                    name: obj.name,
                    email: obj.email,
                    password: obj.password,
                    phoneNumber: parseInt(obj.phoneNumber, 10),
                    address: obj.address
                };
                const emp = await jsonFetch("/api/employees", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                setLastId(emp.id);
                setOutput("Created employee:\n" + JSON.stringify(emp, null, 2));
            } catch (err) {
                alert("Create employee failed: " + err.message);
            }
        };

        const handleUpdate = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const id = Number(obj.id);
                const payload = {};
                if (obj.name) payload.name = obj.name;
                if (obj.email) payload.email = obj.email;
                if (obj.phoneNumber) payload.phoneNumber = parseInt(obj.phoneNumber, 10);
                if (obj.address) payload.address = obj.address;

                const updated = await jsonFetch(`/api/employees/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                setOutput("Updated employee:\n" + JSON.stringify(updated, null, 2));
            } catch (err) {
                alert("Update employee failed: " + err.message);
            }
        };

        const handleUpload = async (e) => {
            e.preventDefault();
            try {
                const formData = new FormData(e.target);
                const id = formData.get("id");
                const file = formData.get("file");

                const uploadFormData = new FormData();
                uploadFormData.append("file", file);

                const res = await fetch(`/api/employees/${id}/profile-picture`, {
                    method: "POST",
                    body: uploadFormData
                });

                if (!res.ok) {
                    throw new Error(`Upload failed: ${res.status} ${res.statusText}`);
                }

                const emp = await res.json();
                setPhotoUrl(emp.profilePictureUrl);
                setOutput("Uploaded picture for employee:\n" + JSON.stringify(emp, null, 2));
            } catch (err) {
                alert("Upload failed: " + err.message);
            }
        };

        const handleLogin = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const payload = { name: obj.name, password: obj.password };
                const emp = await jsonFetch("/api/employees/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                setOutput("Employee logged in:\n" + JSON.stringify(emp, null, 2));
            } catch (err) {
                alert("Employee login failed: " + err.message);
            }
        };

        const handleChangePassword = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const id = Number(obj.id);
                const payload = { oldPassword: obj.oldPassword, newPassword: obj.newPassword };
                const result = await jsonFetch(`/api/employees/${id}/password`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                setOutput("Password changed: " + JSON.stringify(result, null, 2));
            } catch (err) {
                alert("Change password failed: " + err.message);
            }
        };

        const handleList = async () => {
            try {
                const data = await jsonFetch("/api/employees");
                setOutput(JSON.stringify(data, null, 2));
            } catch (err) {
                alert("List employees failed: " + err.message);
            }
        };

        const handleGet = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const id = Number(obj.id);
                const emp = await jsonFetch(`/api/employees/${id}`);
                setOutput(JSON.stringify(emp, null, 2));
            } catch (err) {
                alert("Get employee failed: " + err.message);
            }
        };

        const handleDelete = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const id = Number(obj.id);
                const res = await fetch(`/api/employees/${id}`, { method: "DELETE" });
                if (!res.ok && res.status !== 204) {
                    throw new Error(res.status + " " + res.statusText + ": " + (await res.text()));
                }
                setOutput(`Employee ${id} deleted.`);
            } catch (err) {
                alert("Delete employee failed: " + err.message);
            }
        };

        return (
            <section>
                <h2>Employee (Password Auth)</h2>

                <h3>Register Employee (password REQUIRED)</h3>
                <form onSubmit={handleCreate}>
                    <div><label>Name:</label><input name="name" required /></div>
                    <div><label>Email:</label><input name="email" type="email" required /></div>
                    <div><label>Password:</label><input name="password" type="password" required /></div>
                    <div><label>Phone:</label><input name="phoneNumber" type="number" required /></div>
                    <div><label>Address:</label><input name="address" required /></div>
                    <button type="submit">Create Employee</button>
                </form>
                <p className="small">Last created employee id: <strong>{lastId ?? "-"}</strong></p>

                <h3>Update Employee (partial)</h3>
                <form onSubmit={handleUpdate}>
                    <div><label>Employee ID:</label><input name="id" type="number" required /></div>
                    <div><label>Name:</label><input name="name" /></div>
                    <div><label>Email:</label><input name="email" type="email" /></div>
                    <div><label>Phone:</label><input name="phoneNumber" type="number" /></div>
                    <div><label>Address:</label><input name="address" /></div>
                    <button type="submit">Update Employee</button>
                </form>

                <h3>Change Employee Password</h3>
                <form onSubmit={handleChangePassword}>
                    <div><label>Employee ID:</label><input name="id" type="number" required /></div>
                    <div><label>Old Password:</label><input name="oldPassword" type="password" required /></div>
                    <div><label>New Password:</label><input name="newPassword" type="password" required /></div>
                    <button type="submit">Change Password</button>
                </form>

                <h3>Upload Employee Profile Picture</h3>
                <form onSubmit={handleUpload} encType="multipart/form-data">
                    <div><label>Employee ID:</label><input name="id" type="number" required /></div>
                    <div><label>File:</label><input name="file" type="file" accept="image/*" required /></div>
                    <button type="submit">Upload Employee Picture</button>
                </form>
                {photoUrl && <img className="preview" src={photoUrl} alt="Employee" />}

                <h3>Employee Login (via /api/employees/login)</h3>
                <form onSubmit={handleLogin}>
                    <div><label>Name:</label><input name="name" required /></div>
                    <div><label>Password:</label><input name="password" type="password" required /></div>
                    <button type="submit">Login</button>
                </form>

                <h3>List / Get / Delete Employees</h3>
                <div className="row">
                    <button onClick={handleList}>GET /api/employees</button>
                </div>
                <div className="row">
                    <form onSubmit={handleGet} style={{ display: "inline-block", marginRight: "1rem" }}>
                        <label>Employee ID:</label><input name="id" type="number" required style={{ width: "80px" }} />
                        <button type="submit">GET /api/employees/&lt;id&gt;</button>
                    </form>
                    <form onSubmit={handleDelete} style={{ display: "inline-block" }}>
                        <label>Employee ID:</label><input name="id" type="number" required style={{ width: "80px" }} />
                        <button type="submit">DELETE /api/employees/&lt;id&gt;</button>
                    </form>
                </div>

                <pre>{output}</pre>
            </section>
        );
    }

    // ---------- Admin Employees (with password hash) ----------

    function AdminEmployeeSection() {
        const [output, setOutput] = useState("");

        const handleList = async () => {
            try {
                const data = await jsonFetch("/api/admin/employees");
                setOutput(JSON.stringify(data, null, 2));
            } catch (err) {
                alert("Admin list employees failed: " + err.message);
            }
        };

        const handleGet = async (e) => {
            e.preventDefault();
            try {
                const obj = getFormObj(e.target);
                const id = Number(obj.id);
                const emp = await jsonFetch(`/api/admin/employees/${id}`);
                setOutput(JSON.stringify(emp, null, 2));
            } catch (err) {
                alert("Admin get employee failed: " + err.message);
            }
        };

        return (
            <section>
                <h2>Admin – Employees With Password Hash</h2>
                <p className="small">
                    From <code>EmployeeAdminController</code> – includes encoded <code>passwordHash</code>.
                    Dev-only; don&apos;t expose in real production.
                </p>
                <div className="row">
                    <button onClick={handleList}>GET /api/admin/employees</button>
                </div>
                <div className="row">
                    <form onSubmit={handleGet}>
                        <label>Employee ID:</label><input name="id" type="number" required style={{ width: "80px" }} />
                        <button type="submit">GET /api/admin/employees/&lt;id&gt;</button>
                    </form>
                </div>
                <pre>{output}</pre>
            </section>
        );
    }

    function App() {
        return (
            <div className="container">
                <h1>User-Service React Test</h1>
                <p className="small">
                    Dev playground for all controllers + password login + passkeys + change password + partial updates.
                </p>
                <InfoSection />
                <PasskeySection />
                <EmployeeSection />
                <AdminEmployeeSection />
                <ChildrenSection />
                <ParentSection />
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
</script>
</body>
</html>